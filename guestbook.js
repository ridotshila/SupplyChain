import { Lucid, Blockfrost, Data } from "https://unpkg.com/lucid-cardano@0.10.11/web/mod.js";

// ----------------------------
// CONFIG
// ----------------------------
const BLOCKFROST_URL = "https://cardano-preprod.blockfrost.io/api/v0";
const BLOCKFROST_KEY = "preprodYjRkHfcazNkL0xxG9C2RdUbUoTrG7wip";
const NETWORK = "Preprod";

// ----------------------------
// DATUM
// ----------------------------
const GuestDatum = Data.Object({
  author: Data.Bytes(),   // wallet PKH
  message: Data.Text(),   // message text
});

// ----------------------------
// GLOBAL STATE
// ----------------------------
let lucid;
let walletAddress;
let walletPKH;
let scriptAddress;
let script;

// ----------------------------
// LOG FUNCTION
// ----------------------------
function log(msg) {
  const el = document.getElementById("log");
  el.textContent += msg + "\n";
  el.scrollTop = el.scrollHeight;
}

// ----------------------------
// INIT / CONNECT WALLET
// ----------------------------
export async function init() {
  if (!window.cardano?.lace) {
    alert("Lace wallet not found");
    return;
  }

  lucid = await Lucid.new(new Blockfrost(BLOCKFROST_URL, BLOCKFROST_KEY), NETWORK);
  const api = await window.cardano.lace.enable();
  lucid.selectWallet(api);

  walletAddress = await lucid.wallet.address();
  walletPKH = lucid.utils.getAddressDetails(walletAddress).paymentCredential.hash;

  // Replace with your actual CBOR script (single-line, hex)
  const SCRIPT_CBOR = "590e39010000323232323232332232323232323232323322323233223232323232323232323322323232323232323232232323232323232322322323253353232323500225335533532533333350011533333350021036103610371036103610361533333350021036103610361037103710361533333350021036103610361036103610371036103615333333500210361037103610361036103635004222222220011036133573892118696e76616c6964207374617465207472616e736974696f6e00035153355335533333350011035133014350022200235004222222220041330143500222002350042222222200613301435002220023500422222222003133014350022200235004222222220031330143500222002350042222222200510361335738920113756e617574686f72697a6564207369676e657200035153355333333500115335301600221333573466e20ccc050d4d400488004888800c064064d4014888888880080d80dc4c98c80e4cd5ce24810f6e6f2073637269707420696e7075740003a15335301600221333573466e20ccc050d4d400488004888800c064064d4014888888880080d80dc4c98c80e4cd5ce24810f6e6f2073637269707420696e7075740003a15335301600221333573466e20ccc050d4d400488004888800c064064d4014888888880080d80dc4c98c80e4cd5ce24810f6e6f2073637269707420696e7075740003a1333573466e20ccc04cccd54c06c48005406540a0cc054d40108888888800cd400888008060060d4010888888880080d40d84ccd5cd19b8833301333355301b12001501950283301535004222222220073500222002018018350042222222200203503615335301600221333573466e20ccc050d4d400488004888800c064064d4014888888880080d80dc4c98c80e4cd5ce2490f6e6f2073637269707420696e7075740003a10361335738920115626f6e642068616e646c696e6720696e76616c696400035103510353333573466e1cd55cea80224000466442466002006004646464646464646464646464646666ae68cdc39aab9d500c480008cccccccccccc88888888888848cccccccccccc00403403002c02802402001c01801401000c008cd40bc0c0d5d0a80619a8178181aba1500b33502f03135742a014666aa066eb940c8d5d0a804999aa819bae503235742a01066a05e07a6ae85401cccd540cc0f9d69aba150063232323333573466e1cd55cea801240004664424660020060046464646666ae68cdc39aab9d5002480008cc8848cc00400c008cd4121d69aba150023049357426ae8940088c98c8138cd5ce02702782609aab9e5001137540026ae854008c8c8c8cccd5cd19b8735573aa004900011991091980080180119a8243ad35742a00460926ae84d5d1280111931902719ab9c04e04f04c135573ca00226ea8004d5d09aba2500223263204a33573809409609026aae7940044dd50009aba1500533502f75c6ae854010ccd540cc0e88004d5d0a801999aa819bae200135742a00460786ae84d5d1280111931902319ab9c046047044135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d55cf280089baa00135742a00860586ae84d5d1280211931901c19ab9c0380390363333573466e1cd55cea802a4000464246002004606a6ae84d55cf280311931901b99ab9c0370380353333573466e1cd55cea806a400046666666644444444246666666600201201000e00c00a0080060046eb8d5d0a8069bae35742a0186eb8d5d0a8059bae35742a0146eb8d5d0a8049bae35742a0106eb4d5d0a803981a1aba135744a00e464c6406c66ae700d80dc0d040d8584d55cf280089baa0011375400226ae8940044d5d1280089aba25001135744a00226ae8940044d5d1280089aab9e5001137540024446464600200a640026aa05a4466a0029000111a80111299a999ab9a3371e00401205a0582600e0022600c006640026aa0584466a0029000111a80111299a999ab9a3371e00400e05805620022600c006446a004444444444444a66a666aa603224002a0224a66a666ae68cdc780700081881809a8138008a813002108188817911a800911111111111199aa980a09000911a80111111a8021119a8011299a999ab9a3371e02e00207006e266a05200c01020104010a04201446a002446a0044444444444446666a01a4a04a4a04a4a04a4666aa603224002a02246a00244a66aa66a666ae68cdc79a801110011a802110010198190999ab9a3370e6a004440026a00844002066064206426a0520062a05001a266a01244a66a004420062002a0289110012233553007120012350012233550150023355300a12001235001223355018002333500123302b4800000488cc0b00080048cc0ac00520000013355300712001235001223355015002333500123355300b1200123500122335501900235500d0010012233355500800f00200123355300b1200123500122335501900235500c00100133355500300a002001111222333553004120015010335530071200123500122335501500235500900133355300412001223500222533533355300c120013233500e223335003220020020013500122001123300122533500210261001023235001223300a002005006100313350140040035011001335530071200123500122323355016003300100532001355028225335001135500a003221350022253353300c002008112223300200a0041300600300232001355021221122253350011002221330050023335530071200100500400111212223003004112122230010043200135501e22112253350011500e22133500f300400233553006120010040013200135501d2211222533500113500322001221333500522002300400233355300712001005004001122123300100300222333573466e3c00800405c05848c88c008dd6000990009aa80d911999aab9f0012500a233500930043574200460066ae8800806c8c8c8cccd5cd19b8735573aa004900011991091980080180118079aba150023005357426ae8940088c98c8068cd5ce00d00d80c09aab9e5001137540024646464646666ae68cdc39aab9d5004480008cccc888848cccc00401401000c008c8c8c8cccd5cd19b8735573aa0049000119910919800801801180c1aba15002335010017357426ae8940088c98c807ccd5ce00f81000e89aab9e5001137540026ae854010ccd54021d728039aba150033232323333573466e1d4005200423212223002004357426aae79400c8cccd5cd19b875002480088c84888c004010dd71aba135573ca00846666ae68cdc3a801a400042444006464c6404266ae7008408807c0780744d55cea80089baa00135742a00466a018eb8d5d09aba2500223263201b33573803603803226ae8940044d5d1280089aab9e500113754002266aa002eb9d6889119118011bab00132001355018223233335573e0044a010466a00e66aa012600c6aae754008c014d55cf280118021aba20030191357420022244004244244660020080062244246600200600424464646666ae68cdc3a800a400046a00e600a6ae84d55cf280191999ab9a3370ea00490011280391931900a99ab9c015016013012135573aa00226ea800448488c00800c44880048c8c8cccd5cd19b875001480188c848888c010014c01cd5d09aab9e500323333573466e1d400920042321222230020053009357426aae7940108cccd5cd19b875003480088c848888c004014c01cd5d09aab9e500523333573466e1d40112000232122223003005375c6ae84d55cf280311931900999ab9c01301401101000f00e135573aa00226ea80048c8c8cccd5cd19b8735573aa004900011991091980080180118029aba15002375a6ae84d5d1280111931900799ab9c00f01000d135573ca00226ea80048c8cccd5cd19b8735573aa002900011bae357426aae7940088c98c8034cd5ce00680700589baa001232323232323333573466e1d4005200c21222222200323333573466e1d4009200a21222222200423333573466e1d400d2008233221222222233001009008375c6ae854014dd69aba135744a00a46666ae68cdc3a8022400c4664424444444660040120106eb8d5d0a8039bae357426ae89401c8cccd5cd19b875005480108cc8848888888cc018024020c030d5d0a8049bae357426ae8940248cccd5cd19b875006480088c848888888c01c020c034d5d09aab9e500b23333573466e1d401d2000232122222223005008300e357426aae7940308c98c8058cd5ce00b00b80a00980900880800780709aab9d5004135573ca00626aae7940084d55cf280089baa0012323232323333573466e1d400520022333222122333001005004003375a6ae854010dd69aba15003375a6ae84d5d1280191999ab9a3370ea0049000119091180100198041aba135573ca00c464c6401e66ae7003c0400340304d55cea80189aba25001135573ca00226ea80048c8c8cccd5cd19b875001480088c8488c00400cdd71aba135573ca00646666ae68cdc3a8012400046424460040066eb8d5d09aab9e500423263200c33573801801a01401226aae7540044dd500089119191999ab9a3370ea00290021091100091999ab9a3370ea00490011190911180180218031aba135573ca00846666ae68cdc3a801a400042444004464c6401a66ae7003403802c0280244d55cea80089baa0012323333573466e1d40052002200523333573466e1d40092000200523263200933573801201400e00c26aae74dd50008910010910009191999ab9a3370ea00290051091111100191999ab9a3370ea00490041091111100111999ab9a3370ea00690031091111100291999ab9a3370ea00890021091111100091999ab9a3370ea00a90011091111100211999ab9a3370ea00c90001091111100311931900519ab9c00a00b008007006005004003135573a6ea80052649010350543100120012233700004002224646002002446600660040040021"; 
  script = { type: "PlutusV2", script: SCRIPT_CBOR };
  scriptAddress = lucid.utils.validatorToAddress(script);

  log("✅ Wallet connected");
  log("Address: " + walletAddress);
  log("Script: " + scriptAddress);
}

// ----------------------------
// CREATE DATUM
// ----------------------------
function mkGuestDatum(message) {
  return Data.to({
    author: walletPKH,
    message,
  }, GuestDatum);
}

// ----------------------------
// SUBMIT MESSAGE
// ----------------------------
export async function submitMessage() {
  try {
    const message = document.getElementById("message").value.trim();
    if (!message) return log("❌ Message cannot be empty");

    const datum = mkGuestDatum(message);

    const tx = await lucid.newTx()
      .payToContract(scriptAddress, { inline: datum }, { lovelace: 1_000_000n }) // 1 ADA minimum
      .complete();

    const signed = await tx.sign().complete();
    const txHash = await signed.submit();

    log("✅ Message submitted! TxHash: " + txHash);
    document.getElementById("message").value = "";
  } catch (e) {
    log("❌ " + e.message);
  }
}

// ----------------------------
// BUTTONS
// ----------------------------
document.getElementById("connect").onclick = init;
document.getElementById("submit").onclick = submitMessage;
